name: verify-cli-reports

on: pull_request

jobs:
  verify-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install package with optional dependencies
        run: pip install -e .[opt]

      - name: Trigger xDEM example data download
        run: python -c "import xdem; xdem.examples.get_path('longyearbyen_ref_dem')"

      - name: Install PDF utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Verify reports for documentation are up to date
        shell: bash
        run: |
          cd doc/source/_workflows
          
          # Function to convert PDF to text for comparison
          normalize_pdf () {
            pdftotext -layout "$1" - | \
              sed -E '
                # Remove volatile metadata
                /^xDEM version:/d
                /^Date:/d
                /^Computing time:/d
              ' | \
              # Normalize whitespace
              tr -s ' ' | \
              # Remove empty lines
              sed '/^$/d'
          }

          set -euo pipefail
          
          failures=()
          
          check_report () {
            name="$1"
            cmd="$2"
            expected="$3"
                    
            echo "Checking report: $name"
            eval "$cmd"
          
            if ! diff -u \
              <(normalize_pdf "$expected") \
              <(normalize_pdf "outputs_${name}/report.pdf"); then
              failures+=("$name")
              echo "::error::Report '$name' is out of date (ignoring version/date metadata)."
              echo "::error::Run:"
              echo "::error::  cd doc/source/_workflows"
              echo "::error::  xdem $name --config ${name}_config.yaml"
            fi
          }
          
          check_report \
            "accuracy" \
            "xdem accuracy --config accuracy_config.yaml --output test_accuracy" \
            "test_accuracy/report.pdf"
          
          check_report \
            "topo" \
            "xdem topo --config topo_config.yaml --output test_topo" \
            "test_topo/report.pdf"
          
          if (( ${#failures[@]} > 0 )); then
            echo ""
            echo "The following reports are out of date:"
            for r in "${failures[@]}"; do
              echo "  - $r"
            done
            exit 1
          fi
          
          echo "All reports are up to date."